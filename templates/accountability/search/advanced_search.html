{% extends "base.html" %}
{% load humanize %}

{% block title %}Consultar Prestações - Portal SITTS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <p class="text-2xl mb-3 font-bold">
        Consultar Prestações
    </p>

    <div class="my-4">
        <form method="GET">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400 group-focus-within:text-blue-500 transition-colors duration-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                    </svg>
                </div>
                
                <input
                    type="text"
                    id="id-search-input"
                    name="q"
                    value="{{ search_query }}"
                    placeholder="Pesquisar por identificação, item, favorecido, ou contrato..."
                    class="
                        block
                        w-full
                        pl-12
                        pr-72
                        py-3
                        text-sm
                        text-gray-900
                        bg-white
                        border
                        border-gray-300
                        rounded-lg
                        shadow-sm
                        placeholder-gray-500
                        transition-all
                        duration-200
                        focus:outline-none
                        focus:ring-2
                        focus:ring-blue-500
                        focus:border-blue-500
                        focus:shadow-md
                        hover:border-gray-400
                        hover:shadow-sm
                    "
                    autocomplete="off"
                    spellcheck="false"
                />
                
                <div class="absolute inset-y-0 right-0 flex items-center pr-2 gap-2">
                    <button
                        type="button"
                        id="toggle-filters"
                        class="
                            inline-flex
                            items-center
                            justify-center
                            px-5
                            py-2.5
                            text-sm
                            font-medium
                            text-gray-700
                            bg-white
                            border
                            border-gray-300
                            rounded-lg
                            shadow-sm
                            transition-all
                            duration-200
                            hover:bg-gray-100
                            hover:shadow-md
                            focus:outline-none
                            focus:ring-2
                            focus:ring-offset-2
                            focus:ring-gray-500
                            active:bg-gray-100
                        "
                    >
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                        </svg>
                        Filtros
                        <span id="filter-icon" class="ml-1.5 transition-transform duration-200">▼</span>
                    </button>
                    <button
                        type="submit"
                        class="
                            inline-flex
                            items-center
                            justify-center
                            px-6
                            py-2.5
                            text-sm
                            font-medium
                            text-white
                            bg-blue-600
                            border
                            border-transparent
                            rounded-lg
                            shadow-sm
                            transition-all
                            duration-200
                            hover:bg-blue-700
                            hover:shadow-md
                            focus:outline-none
                            focus:ring-2
                            focus:ring-offset-2
                            focus:ring-blue-500
                            active:bg-blue-800
                            disabled:opacity-50
                            disabled:cursor-not-allowed
                        "
                    >
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Buscar
                    </button>
                </div>
            </div>
            
            {% if search_query %}
            <div class="mt-3 flex flex-wrap gap-2">
                <div class="text-xs text-gray-500">
                    Pesquisando por: <span class="font-medium text-gray-700">"{{ search_query }}"</span>
                </div>
            </div>
            {% endif %}

            <div id="advanced-filters" class="hidden mt-3 p-4 bg-white rounded-lg border border-gray-200 shadow-sm transition-all duration-200">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Registro</label>
                        <select 
                            id="type" 
                            name="type"
                            class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 p-2.5"
                        >
                            <option value="all" {% if record_type == "all" %}selected{% endif %}>Todos</option>
                            <option value="expense" {% if record_type == "expense" %}selected{% endif %}>Apenas Despesas</option>
                            <option value="revenue" {% if record_type == "revenue" %}selected{% endif %}>Apenas Receitas</option>
                        </select>
                    </div>

                    <div>
                        <label for="conciled" class="block text-sm font-medium text-gray-700 mb-2">Status de Conciliação</label>
                        <select 
                            id="conciled" 
                            name="conciled"
                            class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 p-2.5"
                        >
                            <option value="all" {% if conciled_status == "all" %}selected{% endif %}>Todos</option>
                            <option value="conciled" {% if conciled_status == "conciled" %}selected{% endif %}>Conciliados</option>
                            <option value="not_conciled" {% if conciled_status == "not_conciled" %}selected{% endif %}>Pendentes</option>
                        </select>
                    </div>

                    <div>
                        <label for="contract" class="block text-sm font-medium text-gray-700 mb-2">Contrato</label>
                        <select 
                            id="contract" 
                            name="contract"
                            class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 p-2.5"
                        >
                            <option value="">Todos</option>
                            {% for contract in contracts %}
                                <option value="{{ contract.id }}" {% if contract_id == contract.id|stringformat:"s" %}selected{% endif %}>
                                    {{ contract.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="favored" class="block text-sm font-medium text-gray-700 mb-2">Favorecido</label>
                        <select 
                            id="favored" 
                            name="favored"
                            class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 p-2.5"
                        >
                            <option value="">Todos</option>
                            {% for favored in favoreds %}
                                <option value="{{ favored.id }}" {% if favored_id == favored.id|stringformat:"s" %}selected{% endif %}>
                                    {{ favored.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status de Revisão</label>
                        <select 
                            id="status" 
                            name="status"
                            class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 p-2.5"
                        >
                            <option value="all" {% if status == "all" %}selected{% endif %}>Todos</option>
                            <option value="PENDING" {% if status == "PENDING" %}selected{% endif %}>Pendente</option>
                            <option value="APPROVED" {% if status == "APPROVED" %}selected{% endif %}>Aprovado</option>
                            <option value="REJECTED" {% if status == "REJECTED" %}selected{% endif %}>Rejeitado</option>
                        </select>
                    </div>

                    <div>
                        <label for="paid" class="block text-sm font-medium text-gray-700 mb-2">Status de Pagamento</label>
                        <select 
                            id="paid" 
                            name="paid"
                            class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 p-2.5"
                        >
                            <option value="all" {% if paid_status == "all" %}selected{% endif %}>Todos</option>
                            <option value="paid" {% if paid_status == "paid" %}selected{% endif %}>Pago</option>
                            <option value="unpaid" {% if paid_status == "unpaid" %}selected{% endif %}>Pendente</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="w-full">
                                <input 
                                    type="date" 
                                    id="start_date" 
                                    name="start_date" 
                                    value="{{ start_date }}"
                                    class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 p-2.5"
                                    placeholder="Data inicial"
                                />
                            </div>
                            <div class="w-full">
                                <input 
                                    type="date" 
                                    id="end_date" 
                                    name="end_date" 
                                    value="{{ end_date }}"
                                    class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg shadow-sm transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 p-2.5"
                                    placeholder="Data final"
                                />
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-start pt-3 mt-3 border-t border-gray-200">
                    <a 
                        href="{% url 'accountability:advanced-search' %}"
                        class="
                            inline-flex
                            items-center
                            px-4
                            py-1.5
                            text-xs
                            font-medium
                            text-gray-600
                            bg-gray-50
                            border
                            border-gray-200
                            rounded-md
                            transition-all
                            duration-200
                            hover:bg-gray-100
                            hover:text-gray-700
                            focus:outline-none
                            focus:ring-2
                            focus:ring-gray-400
                        "
                    >
                        <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Limpar Filtros
                    </a>
                </div>
            </div>
        </form>
    </div>

    {% if expenses or revenues %}
        <div class="bg-white shadow-md rounded-lg border border-gray-200 p-5">
            <div class="flex items-center justify-between mb-5">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Resultados da Pesquisa</h2>
                    <div class="flex gap-4 mt-2 text-sm">
                        {% if expenses %}
                            <span class="inline-flex items-center px-3 py-1.5 bg-red-50 text-red-700 rounded-lg font-medium text-xs">
                                Despesas: {{ expenses|length }} (R$ {{ expenses_total|intcomma }})
                            </span>
                        {% endif %}
                        {% if revenues %}
                            <span class="inline-flex items-center px-3 py-1.5 bg-green-50 text-green-700 rounded-lg font-medium text-xs">
                                Receitas: {{ revenues|length }} (R$ {{ revenues_total|intcomma }})
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if expenses %}
                <div class="mb-6">
                    <h3 class="text-base font-semibold text-gray-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                        </svg>
                        Despesas ({{ expenses|length }})
                    </h3>
                    <div class="overflow-hidden shadow-md rounded-lg border border-gray-200">
                        <table class="min-w-full text-sm text-left text-gray-500 table-fixed">
                            <thead class="text-xs text-white uppercase bg-gray-500">
                                <tr>
                                    <th scope="col" class="px-4 py-3 w-[15%]">Identificação</th>
                                    <th scope="col" class="px-4 py-3 w-[10%]">Valor</th>
                                    <th scope="col" class="px-4 py-3 w-[8%]">Data</th>
                                    <th scope="col" class="px-4 py-3 w-[20%]">Contrato</th>
                                    <th scope="col" class="px-4 py-3 w-[15%]">Favorecido</th>
                                    <th scope="col" class="px-4 py-3 w-[12%]">Status</th>
                                    <th scope="col" class="px-4 py-3 w-[10%]">Conciliado</th>
                                    <th scope="col" class="px-4 py-3 w-[10%]">Pago</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in expenses %}
                                    <tr class="bg-white border-b hover:bg-gray-100">
                                        <td class="px-4 py-3 font-medium text-gray-900">
                                            <div class="truncate" title="{{ expense.identification }}">{{ expense.identification }}</div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">R$ {{ expense.value|intcomma }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap">{{ expense.competency|date:"d/m/Y" }}</td>
                                        <td class="px-4 py-3 truncate max-w-[80px]" title="{{ expense.accountability.contract.name }}">
                                            {{ expense.accountability.contract.name }}
                                        </td>
                                        <td class="px-4 py-3 truncate max-w-[80px]" title="{{ expense.favored.name|default:'-' }}">
                                            {{ expense.favored.name|default:"-" }}
                                        </td>
                                        <td class="px-4 py-3">
                                            <span class="inline-block px-2 py-1 text-xs font-medium rounded-full whitespace-nowrap
                                                {% if expense.status == 'APPROVED' %}bg-green-100 text-green-800
                                                {% elif expense.status == 'REJECTED' %}bg-red-100 text-red-800
                                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                                {{ expense.get_status_display }}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3">
                                            {% if expense.conciled %}
                                                <span class="inline-block px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full whitespace-nowrap">Sim</span>
                                            {% else %}
                                                <span class="inline-block px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full whitespace-nowrap">Não</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-3">
                                            {% if expense.paid %}
                                                <span class="inline-block px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full whitespace-nowrap">Pago</span>
                                            {% else %}
                                                <span class="inline-block px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full whitespace-nowrap">Pendente</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}

            {% if revenues %}
                <div>
                    <h3 class="text-base font-semibold text-gray-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        Receitas ({{ revenues|length }})
                    </h3>
                    <div class="overflow-hidden shadow-md rounded-lg border border-gray-200">
                        <table class="min-w-full text-sm text-left text-gray-500 table-fixed">
                            <thead class="text-xs text-white uppercase bg-gray-500">
                                <tr>
                                    <th scope="col" class="px-4 py-3 w-[15%]">Conta Bancária</th>
                                    <th scope="col" class="px-4 py-3 w-[10%]">Valor</th>
                                    <th scope="col" class="px-4 py-3 w-[8%]">Data</th>
                                    <th scope="col" class="px-4 py-3 w-[20%]">Contrato</th>
                                    <th scope="col" class="px-4 py-3 w-[15%]">Fonte</th>
                                    <th scope="col" class="px-4 py-3 w-[12%]">Status</th>
                                    <th scope="col" class="px-4 py-3 w-[10%]">Conciliado</th>
                                    <th scope="col" class="px-4 py-3 w-[10%]">Pago</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for revenue in revenues %}
                                    <tr class="bg-white border-b hover:bg-gray-100">
                                        <td class="px-4 py-3 font-medium text-gray-900 text-center">
                                            {{ revenue.bank_account.account }} / {{ revenue.bank_account.agency }}<br>
                                            {{ revenue.bank_account.bank_name }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">R$ {{ revenue.value|intcomma }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap">{{ revenue.competency|date:"d/m/Y" }}</td>
                                        <td class="px-4 py-3 truncate max-w-[80px]" title="{{ revenue.accountability.contract.name }}">
                                            {{ revenue.accountability.contract.name }}
                                        </td>
                                        <td class="px-4 py-3 truncate max-w-[80px]" title="{{ revenue.get_source_display|default:'-' }}">
                                            {{ revenue.get_source_display|default:"-" }}
                                        </td>
                                        <td class="px-4 py-3">
                                            <span class="inline-block px-2 py-1 text-xs font-medium rounded-full whitespace-nowrap
                                                {% if revenue.status == 'APPROVED' %}bg-green-100 text-green-800
                                                {% elif revenue.status == 'REJECTED' %}bg-red-100 text-red-800
                                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                                {{ revenue.get_status_display }}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3">
                                            {% if revenue.conciled %}
                                                <span class="inline-block px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full whitespace-nowrap">Sim</span>
                                            {% else %}
                                                <span class="inline-block px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full whitespace-nowrap">Não</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-3">
                                            {% if revenue.paid %}
                                                <span class="inline-block px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full whitespace-nowrap">Pago</span>
                                            {% else %}
                                                <span class="inline-block px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full whitespace-nowrap">Pendente</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        </div>
    {% elif request.GET %}
        <div class="bg-white shadow-md rounded-lg border border-gray-200 p-5">
            <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3 class="mt-3 text-base font-semibold text-gray-900">Nenhum resultado encontrado</h3>
                <p class="mt-1 text-sm text-gray-500">Tente ajustar seus critérios de pesquisa.</p>
            </div>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('id-search-input');
  const searchForm = searchInput.closest('form');
  const toggleButton = document.getElementById('toggle-filters');
  const filterIcon = document.getElementById('filter-icon');
  const advancedFilters = document.getElementById('advanced-filters');
  
  toggleButton.addEventListener('click', function() {
    advancedFilters.classList.toggle('hidden');
    if (advancedFilters.classList.contains('hidden')) {
      filterIcon.textContent = '▼';
      filterIcon.style.transform = 'rotate(0deg)';
    } else {
      filterIcon.textContent = '▲';
      filterIcon.style.transform = 'rotate(180deg)';
    }
  });

  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('start_date') || urlParams.has('end_date') || 
      urlParams.has('type') || urlParams.has('conciled') || 
      urlParams.has('contract') || urlParams.has('favored') || 
      urlParams.has('status') || urlParams.has('paid')) {
    advancedFilters.classList.remove('hidden');
    filterIcon.textContent = '▲';
    filterIcon.style.transform = 'rotate(180deg)';
  }
  
  document.addEventListener('keydown', function(e) {
    if (e.key === '/' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
      e.preventDefault();
      searchInput.focus();
    }
    
    if (e.key === 'Escape' && e.target === searchInput) {
      searchInput.value = '';
      searchInput.blur();
    }
  });
  
  searchForm.addEventListener('submit', function() {
    const submitButton = searchForm.querySelector('button[type="submit"]');
    const buttonText = submitButton.querySelector('span') || submitButton;
    const originalText = buttonText.textContent || buttonText.innerText;
    
    submitButton.disabled = true;
    buttonText.textContent = 'Buscando...';
    
    setTimeout(() => {
      submitButton.disabled = false;
      buttonText.textContent = originalText;
    }, 3000);
  });
  
  searchInput.addEventListener('focus', function() {
    this.select();
  });
});
</script>

{% endblock %}
