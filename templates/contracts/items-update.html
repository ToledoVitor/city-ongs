{% extends "base.html" %}

{% block title %}Contratos - Itens{% endblock %}

{% block content %}

<p class="text-3xl mb-4 font-bold">
  Atualizar Item
</p>

<nav class="flex mb-6" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
    <li class="inline-flex items-center">
      <a href="{% url 'home' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
        <svg class="w-3 h-3 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
          <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
        </svg>
        Início
      </a>
    </li>
    <li>
      <div class="flex items-center">
        <svg class="rtl:rotate-180 w-3 h-3 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
        </svg>
        <a href="{% url 'contracts:contracts-list' %}" class="ms-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ms-2">Contratos</a>
      </div>
    </li>
    <li>
      <div class="flex items-center">
        <svg class="rtl:rotate-180 w-3 h-3 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
        </svg>
        <a href="{% url 'contracts:contracts-detail' contract.id %}" class="ms-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ms-2">{{ contract.name }}</a>
      </div>
    </li>
    <li aria-current="page">
      <div class="flex items-center">
        <svg class="rtl:rotate-180 w-3 h-3 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
        </svg>
        <span class="ms-1 text-sm font-medium text-gray-500 md:ms-2">
          {% if item %}
          Atualizar Item
          {% else %}
          Adicionar Item
          {% endif %}
        </span>
      </div>
    </li>
  </ol>
</nav>

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
<form method="post" class="space-y-8">
  {% csrf_token %}

  <div class="bg-white shadow-lg rounded-xl border border-gray-100 overflow-hidden">
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
      <div class="flex items-center space-x-3">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Especificações do Item</h2>
          <p class="text-sm text-gray-600">Informações básicas e descrição do item</p>
        </div>
      </div>
    </div>
    
    <div class="p-6 space-y-6">
      <div class="space-y-2">
        <label for="id_name" class="block text-sm font-medium text-gray-700">
          Nome
          <span class="text-red-500">*</span>
        </label>
        {{ form.name }}
      </div>

      <div class="space-y-2">
        <label for="id_objective" class="block text-sm font-medium text-gray-700">
          Objetivo
          <span class="text-red-500">*</span>
        </label>
        {{ form.objective }}
      </div>

      <div class="space-y-2">
        <label for="id_methodology" class="block text-sm font-medium text-gray-700">
          Metodologia
          <span class="text-red-500">*</span>
        </label>
        {{ form.methodology }}
      </div>

      <div class="space-y-2">
        <label for="id_observations" class="block text-sm font-medium text-gray-700">Observações</label>
        {{ form.observations }}
      </div>
    </div>
  </div>

  <div class="bg-white shadow-lg rounded-xl border border-gray-100 overflow-hidden">
    <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-gray-200">
      <div class="flex items-center space-x-3">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
          </div>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Detalhamento da Despesa</h2>
          <p class="text-sm text-gray-600">Informações financeiras e cronograma</p>
        </div>
      </div>
    </div>
    
    <div class="p-6 space-y-6">
      <div class="space-y-2">
        <label for="id_source" class="block text-sm font-medium text-gray-700">
          Fonte de recursos
          <span class="text-gray-400 text-xs">(federal ou contrapartida)</span>
          <span class="text-red-500">*</span>
        </label>
        {{ form.source }}
      </div>
      
      <div class="grid gap-6 lg:grid-cols-2">
        <div class="space-y-2">
          <label for="id_nature" class="block text-sm font-medium text-gray-700">
            Natureza
            <span class="text-red-500">*</span>
          </label>
          {% include 'commons/nature-select.html' with id='id_nature' name='nature' selected_value=form.nature.value %}
        </div>
        
        <div class="space-y-2">
          <label for="id_month_quantity" class="block text-sm font-medium text-gray-700">
            Quantidade Mensal
            <span class="text-red-500">*</span>
          </label>
          {{ form.month_quantity }}
        </div>
      </div>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700">
            Início da Despesa
            <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM4 7h12v9H4V7z"></path>
              </svg>
            </div>
            <input 
                datepicker
                datepicker-format="dd/mm/yyyy"
                datepicker-language="pt"
                datepicker-autohide
                value="{{ item.start_date|date:'d/m/Y' }}"
                required
                id="id_start_date"
                name="start_date"
                type="text"
                class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-200 text-gray-900 placeholder-gray-400 transition-colors"
            >
          </div>
        </div>
  
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700">
            Término da Despesa
            <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM4 7h12v9H4V7z"></path>
              </svg>
            </div>
            <input 
                datepicker
                datepicker-format="dd/mm/yyyy"
                datepicker-language="pt"
                datepicker-autohide
                value="{{ item.end_date|date:'d/m/Y' }}"
                required
                id="id_end_date"
                name="end_date"
                type="text"
                class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-200 text-gray-900 placeholder-gray-400 transition-colors"
            >
          </div>
        </div>
      </div>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="space-y-2">
          <label for="id_quantity" class="block text-sm font-medium text-gray-700">
            Quantidade de Meses
            <span class="text-red-500">*</span>
          </label>
          {{ form.quantity }}
        </div>
        
        <div class="space-y-2">
          <label for="id_unit_type" class="block text-sm font-medium text-gray-700">
            Unidade
            <span class="text-gray-400 text-xs">(und., kg, litros, ...)</span>
            <span class="text-red-500">*</span>
          </label>
          {{ form.unit_type }}
        </div>
      </div>

      <div class="grid gap-6 lg:grid-cols-2">
        <div class="space-y-2">
          <label for="id_month_expense" class="block text-sm font-medium text-gray-700">
            Gasto Mensal por Unidade
            <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
              </svg>
            </div>
            <input
              type="text"
              id="id_month_expense"
              name="month_expense"
              value="{{ item.month_expense }}"
              oninput="formatMoney(this)"
              placeholder="0,00"
              class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-200 text-gray-900 placeholder-gray-400 transition-colors"
            />  
          </div>  
        </div>

        <div class="space-y-2">
          <label for="id_anual_expense" class="block text-sm font-medium text-gray-700">
            Gasto Anual
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 ml-2">
              Calculado automaticamente
            </span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
              </svg>
            </div>
            <input
              type="text"
              id="id_anual_expense"
              name="anual_expense"
              placeholder="0,00"
              value="{{ item.anual_expense }}"
              class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed"
              disabled
            />  
          </div>  
        </div>
      </div>
    </div>
  </div>

  {% include 'commons/form-errors.html' with form=form %}

  <div class="flex justify-end items-center gap-4">
    <a href="{% url 'contracts:contracts-detail' contract.id %}" class="inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 focus:ring-2 focus:ring-gray-200 focus:outline-none transition-all duration-200 shadow-sm">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Cancelar
    </a>
    
    <button type="submit" class="inline-flex items-center justify-center px-6 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      Atualizar Item
    </button>
  </div>
</form>
</div>

<script>
  function formatMoney(input) {
    console.log(input.value)
    let value = input.value.replace(/\D/g, "");

    if (!value) {
      input.value = "0"
      return
    }

    value = (parseFloat(value) / 100).toLocaleString("pt-BR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });

    input.value = value;
  }

  function parseCurrency(value) {
    return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
  }

  function calculateAnnualExpense() {
      var monthQuantity = document.getElementById('id_month_quantity').value.trim();
      var quantity = document.getElementById('id_quantity').value.trim();
      var monthExpense = document.getElementById('id_month_expense').value.trim();

      if (!monthQuantity || !quantity || !monthExpense) {
          document.getElementById('id_anual_expense').value = "";
          return;
      }

      var mQuantity = parseFloat(monthQuantity) || 0;
      var q = parseFloat(quantity) || 0;
      var mExpense = parseCurrency(monthExpense);

      var annualExpense = mQuantity * q * mExpense;

      var formattedAnnualExpense = annualExpense.toLocaleString("pt-BR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
      });

      document.getElementById('id_anual_expense').value = formattedAnnualExpense;
  }

  document.getElementById('id_month_quantity').addEventListener('input', calculateAnnualExpense);
  document.getElementById('id_quantity').addEventListener('input', calculateAnnualExpense);
  document.getElementById('id_month_expense').addEventListener('input', calculateAnnualExpense);

  formatMoney(document.getElementById('id_month_expense'));
  calculateAnnualExpense();
</script>

{% endblock %}
